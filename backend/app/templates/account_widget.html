<!DOCTYPE html>
<html>
<head>
  <title>Account Widget</title>
  <meta charset="UTF-8" />
  <style>
    body {
      margin: 0;
      background-color: {{ bg_color }};
      color: {{ font_color }};
      font-family: '{{ font }}', sans-serif;
      font-size: {{ font_size }}px;
    }

    .container {
      display: flex;
      flex-direction: {% if layout == "vertical" %}column{% else %}row{% endif %};
      flex-wrap: wrap;
      gap: 1rem;
      padding: 1rem;
      overflow: hidden;
    }

    .trader-box {
      border: 1px solid #666;
      padding: 1em;
      min-width: 200px;
      background: rgba(255, 255, 255, 0.05);
      display: flex;
      flex-direction: column;
      gap: 0.3em;
    }

    .label {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="widgetContainer" class="container {% if layout == 'ticker' %}ticker{% endif %}"></div>

  <script>
    const fields = {{ fields | tojson }};
    let traderList = [];
try {
  traderList = JSON.parse({{ traders | tojson | safe }});
} catch (e) {
  console.warn("⚠️ No trader list found or malformed:", e);
}


    const container = document.getElementById("widgetContainer");

    function fetchAndRender() {
      container.innerHTML = "";

      traderList.forEach(trader => {
        const login = trader.login;
        const label = trader.label;

        fetch(`/static/data/trader_${login}.json`)
          .then(res => res.ok ? res.json() : null)
          .then(data => {
            const box = document.createElement("div");
            box.className = "trader-box";

            if (!data) {
              box.innerHTML = `<div><span class="label">${label}:</span> No data found</div>`;
              container.appendChild(box);
              return;
            }

            if (fields.includes("name")) box.innerHTML += `<div><span class="label">Name:</span> ${data.label}</div>`;
            if (fields.includes("balance")) box.innerHTML += `<div><span class="label">Balance:</span> $${data.balance.toFixed(2)}</div>`;
            if (fields.includes("equity")) box.innerHTML += `<div><span class="label">Equity:</span> $${data.equity.toFixed(2)}</div>`;
            if (fields.includes("asset")) box.innerHTML += `<div><span class="label">Asset:</span> ${data.symbol || "-"}</div>`;
            if (fields.includes("direction")) box.innerHTML += `<div><span class="label">Direction:</span> ${data.direction || "-"}</div>`;
            if (fields.includes("pl")) box.innerHTML += `<div><span class="label">P/L:</span> ${data.pl !== undefined ? data.pl.toFixed(2) : "-"}</div>`;
            if (fields.includes("entry")) box.innerHTML += `<div><span class="label">Entry:</span> ${data.entry || "-"}</div>`;
            if (fields.includes("sl")) box.innerHTML += `<div><span class="label">SL:</span> ${data.sl || "-"}</div>`;
            if (fields.includes("tp")) box.innerHTML += `<div><span class="label">TP:</span> ${data.tp || "-"}</div>`;

            container.appendChild(box);
          })
          .catch(err => {
            console.error("Error loading data for trader:", login, err);
          });
      });
    }

    fetchAndRender();
    setInterval(fetchAndRender, 2000); // Update every 2 seconds
  </script>
</body>
</html>
