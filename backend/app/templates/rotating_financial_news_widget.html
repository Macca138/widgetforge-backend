<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: '{{ font }}', 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: transparent;
            color: {{ font_color }};
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        .widget-container {
            width: {{ width }}{% if width.isdigit() %}px{% endif %};
            height: {{ height }}{% if height.isdigit() %}px{% endif %};
            background: transparent;
            border-radius: {{ border_radius }}px;
            padding: {{ padding }}px;
            overflow: hidden;
            position: relative;
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: {{ item_spacing }}px;
            padding-bottom: 8px;
            border-bottom: 1px solid {{ accent_color }}40;
        }

        .widget-title {
            font-size: {{ title_font_size }}px;
            font-weight: 400;
            color: {{ title_color }};
        }

        .rotation-indicator {
            font-size: {{ meta_font_size }}px;
            color: {{ secondary_color }};
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .rotation-dots {
            display: flex;
            gap: 4px;
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: {{ secondary_color }};
            opacity: 0.4;
            transition: opacity 0.3s ease;
        }

        .dot.active {
            opacity: 1;
            background: {{ accent_color }};
        }

        .feed-container {
            height: calc(100% - 50px);
            position: relative;
            overflow: hidden;
        }

        .feed-section {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            visibility: hidden;
        }
        
        /* News feed (FJ widget) - no transitions to prevent blur */
        #newsFeed {
            transition: none !important;
        }
        
        /* Calendar feed - smooth transitions */
        #calendarFeed {
            transition: opacity 0.6s ease-in-out, visibility 0.6s ease-in-out;
            transition-behavior: allow-discrete;
        }

        .feed-section.active {
            opacity: 1 !important;
            visibility: visible !important;
        }

        .feed-section.exit {
            opacity: 0 !important;
            visibility: hidden !important;
        }

        /* Financial Juice Native Widget Container */
        .fj-native-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            transform: translateZ(0);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .fj-widget-wrapper {
            width: 100%;
            height: 100%;
            position: relative;
            background: {{ item_bg_color }};
            border-radius: {{ border_radius }}px;
            overflow: hidden;
            transform: translateZ(0);
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
        }

        /* Override Financial Juice widget styles to match our theme */
        .fj-widget-wrapper iframe,
        .fj-widget-wrapper > div {
            width: 100% !important;
            height: 100% !important;
            border: none !important;
            border-radius: {{ border_radius }}px !important;
            /* Remove all transform and transition properties that cause blur */
            transform: none !important;
            transition: none !important;
            animation: none !important;
            -webkit-font-smoothing: subpixel-antialiased !important;
            font-smoothing: auto !important;
            text-rendering: auto !important;
        }

        /* Fallback content for when FJ widget is loading */
        .fj-fallback {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: {{ secondary_color }};
            font-size: {{ font_size }}px;
            background: {{ item_bg_color }};
            border-radius: {{ border_radius }}px;
            border: 1px solid {{ accent_color }}40;
            transform: translateZ(0);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Calendar section styles */
        .pinned-item {
            background: {{ high_impact_bg }};
            border: 1px solid {{ high_impact_color }}40;
            border-radius: {{ border_radius }}px;
            padding: {{ item_padding }}px;
            margin-bottom: {{ item_spacing }}px;
            position: relative;
            overflow: hidden;
        }

        .pinned-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: {{ high_impact_color }};
        }

        .pinned-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: {{ high_impact_color }};
            color: white;
            font-size: {{ badge_font_size }}px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            text-transform: uppercase;
        }

        .pinned-title {
            font-size: {{ news_title_size|int + 2 }}px;
            font-weight: 500;
            color: #ffffff;
            margin-bottom: 4px;
            margin-right: 60px;
            line-height: 1.4;
        }

        .pinned-meta {
            font-size: {{ meta_font_size }}px;
            color: {{ meta_color }};
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feed-content {
            height: calc(100% - 50px);
            overflow: hidden;
            padding-bottom: 5px;
            position: relative;
        }

        .event-item {
            background: {{ item_bg_color }};
            border-radius: {{ border_radius }}px;
            padding: {{ item_padding|int - 2 }}px;
            margin-bottom: {{ item_spacing|int - 2 }}px;
            border: 1px solid {{ accent_color }}40;
            transition: opacity 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
            cursor: pointer;
            position: relative;
            opacity: 1;
        }

        .event-item:hover {
            background: {{ hover_color }};
            border-color: {{ accent_color }}60;
        }

        .item-title {
            font-size: {{ news_title_size|int + 2 }}px;
            font-weight: 500;
            color: {{ news_title_color }};
            margin-bottom: 6px;
            line-height: 1.4;
        }

        .event-item.high-impact .item-title,
        .pinned-item .item-title {
            font-size: {{ news_title_size|int + 4 }}px;
            font-weight: 600;
            color: #ffffff;
            line-height: 1.5;
        }

        .item-meta {
            font-size: {{ meta_font_size }}px;
            color: {{ meta_color }};
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .impact-badge {
            font-size: {{ badge_font_size }}px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 8px;
            text-transform: uppercase;
        }

        .impact-high {
            background: {{ high_impact_color }};
            color: white;
        }

        .impact-medium {
            background: #f59e0b;
            color: white;
        }

        .impact-low {
            background: {{ secondary_color }};
            color: white;
        }

        .event-details {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .currency-flag {
            font-size: {{ badge_font_size }}px;
            background: {{ accent_color }};
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .event-time {
            color: {{ normal_color }};
            font-weight: 500;
            font-size: {{ meta_font_size|int + 1 }}px;
        }

        .forecast-data {
            font-size: {{ small_font_size|int + 1 }}px;
            color: {{ secondary_color }};
            margin-top: 4px;
            line-height: 1.3;
        }

        .status-badge {
            background: #22c55e;
            color: white;
            font-size: {{ badge_font_size }}px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 400;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: {{ secondary_color }};
        }

        .error {
            background: {{ error_color }}20;
            border: 1px solid {{ error_color }};
            color: {{ error_color }};
            padding: 12px;
            border-radius: {{ border_radius }}px;
            text-align: center;
            margin: 20px 0;
        }

        .no-events-message {
            background: {{ item_bg_color }};
            border: 1px solid {{ accent_color }}60;
            border-radius: {{ border_radius }}px;
            padding: {{ item_padding }}px;
            margin: {{ item_spacing }}px 0;
            text-align: center;
            color: #ffffff;
        }

        .no-events-title {
            font-size: {{ news_title_size|int + 1 }}px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .no-events-subtitle {
            font-size: {{ small_font_size|int + 1 }}px;
            color: #e2e8f0;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .no-events-disclaimer {
            font-size: {{ meta_font_size|int + 1 }}px;
            color: #cbd5e0;
            font-style: italic;
            line-height: 1.3;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: slideIn 0.4s ease-out;
        }

        .countdown-timer {
            font-size: {{ meta_font_size }}px;
            color: {{ normal_color }};
            font-weight: 500;
        }

        .feed-type-indicator {
            font-size: {{ meta_font_size }}px;
            color: {{ secondary_color }};
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <div class="widget-container">
        <div class="widget-header">
            <div class="widget-title">{{ title }}</div>
            <div class="rotation-indicator">
                <span class="feed-type-indicator" id="feedType">News</span>
                <div class="rotation-dots">
                    <div class="dot active" data-feed="news"></div>
                    <div class="dot" data-feed="calendar"></div>
                </div>
                <span class="countdown-timer" id="countdown">{{ rotation_interval }}s</span>
            </div>
        </div>

        <div class="feed-container">
            <!-- Financial Juice Native Widget Section -->
            <div class="feed-section active" id="newsFeed">
                <div class="fj-native-container">
                    <div class="fj-widget-wrapper">
                        <!-- Financial Juice Widget Container -->
                        <div id="fj-news-widget" class="fj-fallback">
                            Loading Financial Juice news feed...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar Feed Section (RSS-based for validation) -->
            <div class="feed-section" id="calendarFeed">
                <div id="pinnedEvent" class="pinned-item" style="display: none;">
                    <div class="pinned-badge">RECENT</div>
                    <div class="pinned-title"></div>
                    <div class="pinned-meta">
                        <span class="time-ago"></span>
                        <span class="source">Forex Factory</span>
                    </div>
                </div>
                <div class="feed-content" id="calendarContent">
                    <div class="loading">Loading calendar...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Financial Juice Widget Script -->
    <script>
        function loadFinancialJuiceWidget() {
            const container = document.getElementById('fj-news-widget');
            
            // Replace the container with the FJ widget container
            container.id = 'financialjuice-news-widget-container';
            container.className = '';
            container.innerHTML = '';
            
            // Create and load the Financial Juice widget script
            var jo = document.createElement("script");
            jo.type = "text/javascript";
            jo.id = "FJ-Widgets";
            var r = Math.floor(Math.random() * (9999 - 0 + 1) + 0);
            jo.src = "https://feed.financialjuice.com/widgets/widgets.js?r=" + r + "";
            jo.onload = function() { 
                var options = {};
                options.container = "financialjuice-news-widget-container";
                options.mode = "Dark";
                options.width = "268px";
                options.height = "410px";
                options.backColor = "{{ bg_color|replace('#', '') }}";
                options.fontColor = "{{ font_color|replace('#', '') }}";
                options.widgetType = "NEWS";
                new window.FJWidgets.createWidget(options);
            };
            document.getElementsByTagName("head")[0].appendChild(jo);
        }
    </script>

    <script>
        class RotatingWidgetNative {
            constructor() {
                this.currentFeed = 'news';
                this.rotationInterval = {{ rotation_interval }};
                this.refreshInterval = {{ refresh_interval }};
                this.countdownTimer = this.rotationInterval;
                this.isRotating = {{ auto_rotate }};
                this.dynamicTiming = true; // Allow flexible timing based on content
                this.calendarDataLoaded = false;
                
                this.initializeWidget();
                this.startDataRefresh();
                // Start rotation after a brief delay to allow calendar data to load
                setTimeout(() => {
                    this.startRotation();
                }, 2000);
            }

            initializeWidget() {
                // Load Financial Juice native widget
                loadFinancialJuiceWidget();
                
                // Load calendar data (still RSS-based for event validation)
                this.loadCalendarData();
                
                // Click handlers for manual rotation
                document.querySelectorAll('.dot').forEach(dot => {
                    dot.addEventListener('click', (e) => {
                        const feed = e.target.dataset.feed;
                        this.switchToFeed(feed);
                        this.resetCountdown();
                    });
                });
            }

            async loadCalendarData() {
                try {
                    const response = await fetch('/api/combined/rotation-data?news_count={{ news_count }}&events_count={{ events_count }}');
                    const result = await response.json();
                    
                    if (result.success) {
                        this.updateCalendarSection(result.data.calendar_feed);
                        this.calendarDataLoaded = true;
                        console.log('Calendar data loaded successfully');
                    } else {
                        this.showCalendarError('Failed to load calendar data: ' + result.error);
                    }
                } catch (error) {
                    console.error('Error loading calendar data:', error);
                    this.showCalendarError('Network error loading calendar data');
                }
            }

            updateCalendarSection(calendarData) {
                const calendarContent = document.getElementById('calendarContent');
                const pinnedEvent = document.getElementById('pinnedEvent');
                
                // Update pinned event
                if (calendarData.pinned) {
                    this.updatePinnedItem(pinnedEvent, calendarData.pinned, 'event');
                    pinnedEvent.style.display = 'block';
                } else {
                    pinnedEvent.style.display = 'none';
                }
                
                // Update calendar events
                calendarContent.innerHTML = '';
                
                if (calendarData.items && calendarData.items.length > 0) {
                    console.log(`üìä Loading ${calendarData.items.length} calendar events`);
                    this.setupEventRotation(calendarData.items);
                    
                    // If we're currently showing calendar, update the duration immediately
                    if (this.currentFeed === 'calendar') {
                        console.log('üîÑ Calendar is active, updating duration for new event count');
                        this.setCurrentFeedDuration();
                    }
                } else {
                    console.log('‚ö†Ô∏è No calendar events found');
                    const noEventsMessage = this.createNoEventsMessage();
                    calendarContent.appendChild(noEventsMessage);
                    this.calendarEvents = null;
                }
            }

            updatePinnedItem(element, data, type) {
                const title = element.querySelector('.pinned-title');
                const timeAgo = element.querySelector('.time-ago');
                const source = element.querySelector('.source');
                
                title.textContent = data.title;
                timeAgo.textContent = data.time_until || data.time_ago || 'Recent';
                
                if (type === 'event') {
                    source.textContent = 'Forex Factory';
                    if (data.country) {
                        const country = document.createElement('span');
                        country.className = 'currency-flag';
                        country.textContent = data.country;
                        country.style.marginLeft = '8px';
                        source.appendChild(country);
                    }
                }
            }

            createEventItem(item) {
                const div = document.createElement('div');
                div.className = 'event-item';
                
                let forecastHtml = '';
                if (item.actual) {
                    // Show actual results for completed events
                    forecastHtml = `<div class="forecast-data">
                        <strong>Actual: ${item.actual}</strong>
                        ${item.forecast ? ` | Forecast: ${item.forecast}` : ''}
                        ${item.previous ? ` | Previous: ${item.previous}` : ''}
                    </div>`;
                } else if (item.forecast || item.previous) {
                    // Show forecast/previous for upcoming events
                    forecastHtml = `<div class="forecast-data">
                        ${item.forecast ? `Forecast: ${item.forecast}` : ''}
                        ${item.previous ? ` | Previous: ${item.previous}` : ''}
                    </div>`;
                }
                
                div.innerHTML = `
                    <div class="item-title">${item.title}</div>
                    <div class="event-details">
                        <span class="currency-flag">${item.country}</span>
                        <span class="event-time">${item.time_until}</span>
                        <span class="impact-badge impact-${item.impact.toLowerCase()}">${item.impact}</span>
                        ${item.status === 'completed' ? '<span class="status-badge">‚úì</span>' : ''}
                    </div>
                    ${forecastHtml}
                `;
                
                return div;
            }

            createNoEventsMessage() {
                const div = document.createElement('div');
                div.className = 'no-events-message';
                
                div.innerHTML = `
                    <div class="no-events-title">No High Impact Events Today</div>
                    <div class="no-events-subtitle">
                        There are no high impact economic events scheduled for today according to Forex Factory.
                    </div>
                    <div class="no-events-disclaimer">
                        Be sure to check other news sources for events that might still trigger market volatility.
                    </div>
                `;
                
                return div;
            }

            setupEventRotation(events) {
                // Clear any existing event rotation timer
                if (this.eventRotationTimer) {
                    clearInterval(this.eventRotationTimer);
                    this.eventRotationTimer = null;
                }
                
                // Setup automatic event rotation for stream overlay
                if (!events || events.length <= 4) {
                    // If 4 or fewer events, show all at once
                    this.showAllEvents(events);
                    return;
                }
                
                this.calendarEvents = events;
                this.currentEventPage = 0;
                this.eventsPerPage = 4;
                
                this.showEventPage(0);
                this.startEventRotation();
            }
            
            showEventPage(pageIndex) {
                if (!this.calendarEvents || this.calendarEvents.length === 0) return;
                
                const calendarContent = document.getElementById('calendarContent');
                const startIndex = pageIndex * this.eventsPerPage;
                const endIndex = Math.min(startIndex + this.eventsPerPage, this.calendarEvents.length);
                const pageEvents = this.calendarEvents.slice(startIndex, endIndex);
                
                // Clear and add page events with animation
                calendarContent.innerHTML = '';
                pageEvents.forEach((event, index) => {
                    const eventItem = this.createEventItem(event);
                    eventItem.style.opacity = '0.4';
                    eventItem.style.transition = 'opacity 0.5s ease';
                    calendarContent.appendChild(eventItem);
                    
                    // Stagger animations - fade in smoothly
                    setTimeout(() => {
                        eventItem.style.opacity = '1';
                    }, index * 150);
                });
            }
            
            showAllEvents(events) {
                // Show all events at once if 4 or fewer
                const calendarContent = document.getElementById('calendarContent');
                calendarContent.innerHTML = '';
                
                events.forEach((event, index) => {
                    const eventItem = this.createEventItem(event);
                    eventItem.style.opacity = '0.4';
                    eventItem.style.transition = 'opacity 0.5s ease';
                    calendarContent.appendChild(eventItem);
                    
                    // Stagger animations - fade in smoothly
                    setTimeout(() => {
                        eventItem.style.opacity = '1';
                    }, index * 150);
                });
            }
            
            startEventRotation() {
                if (!this.calendarEvents || this.calendarEvents.length <= this.eventsPerPage) return;
                
                // Calculate total pages and use dynamic timing
                const totalPages = Math.ceil(this.calendarEvents.length / this.eventsPerPage);
                const totalCalendarTime = this.calculateDynamicRotationTime();
                
                // Calculate optimal time per page based on total allocated calendar time
                let timePerPage = Math.floor(totalCalendarTime / totalPages);
                timePerPage = Math.max(4, Math.min(timePerPage, 8)); // Between 4-8 seconds per page
                
                console.log(`Event rotation: ${totalPages} pages, ${timePerPage}s per page, total calendar time: ${totalCalendarTime}s`);
                
                this.eventRotationTimer = setInterval(() => {
                    this.currentEventPage = (this.currentEventPage + 1) % totalPages;
                    this.showEventPage(this.currentEventPage);
                }, timePerPage * 1000);
            }

            switchToFeed(feedType) {
                if (feedType === this.currentFeed) return;
                
                console.log(`üîÑ Switching from ${this.currentFeed} to ${feedType}`);
                
                // Clear event rotation timer when switching away from calendar
                if (this.currentFeed === 'calendar' && this.eventRotationTimer) {
                    clearInterval(this.eventRotationTimer);
                    this.eventRotationTimer = null;
                }
                
                // Update current feed FIRST
                this.currentFeed = feedType;
                
                // Update visual indicators
                document.querySelectorAll('.dot').forEach(dot => {
                    dot.classList.toggle('active', dot.dataset.feed === feedType);
                });
                
                document.getElementById('feedType').textContent = feedType === 'news' ? 'News' : 'Calendar';
                
                // Handle transitions differently for each feed
                if (feedType === 'news') {
                    this.switchToNews();
                } else {
                    this.switchToCalendar();
                }
                
                // Set duration for this feed
                this.setCurrentFeedDuration();
            }
            
            switchToNews() {
                // No transition for news (FJ widget) - instant switch
                document.getElementById('calendarFeed').classList.remove('active');
                document.getElementById('calendarFeed').classList.add('exit');
                document.getElementById('newsFeed').classList.add('active');
                
                setTimeout(() => {
                    document.getElementById('calendarFeed').classList.remove('exit');
                }, 100);
            }
            
            switchToCalendar() {
                // Smooth transition for calendar only
                document.getElementById('newsFeed').classList.remove('active');
                document.getElementById('calendarFeed').classList.add('active');
                
                // Start event rotation if needed
                if (this.calendarEvents && this.calendarEvents.length > 4) {
                    this.currentEventPage = 0;
                    this.showEventPage(0);
                    this.startEventRotation();
                }
            }

            startRotation() {
                if (!this.isRotating) return;
                
                // Start with news feed duration
                this.setCurrentFeedDuration();
                
                this.rotationTimer = setInterval(() => {
                    this.countdownTimer--;
                    document.getElementById('countdown').textContent = this.countdownTimer + 's';
                    
                    if (this.countdownTimer <= 0) {
                        const nextFeed = this.currentFeed === 'news' ? 'calendar' : 'news';
                        console.log(`Timer expired. Switching from ${this.currentFeed} to ${nextFeed}`);
                        this.switchToFeed(nextFeed);
                    }
                }, 1000);
            }
            
            calculateDynamicRotationTime() {
                // Calculate how long to spend on calendar based on number of events
                if (!this.calendarEvents || this.calendarEvents.length <= 4) {
                    console.log(`üìÖ Few events (${this.calendarEvents?.length || 0}), using standard ${this.rotationInterval}s`);
                    return this.rotationInterval; // Standard time for few events
                }
                
                const totalPages = Math.ceil(this.calendarEvents.length / 4); // 4 events per page
                const timePerPage = 8; // 8 seconds per page for good readability
                const totalCalendarTime = totalPages * timePerPage;
                const maxTime = 40; // Maximum 40 seconds on calendar
                const finalTime = Math.min(totalCalendarTime, maxTime);
                
                console.log(`üìÖ Calendar timing: ${this.calendarEvents.length} events ‚Üí ${totalPages} pages √ó ${timePerPage}s = ${finalTime}s`);
                return finalTime;
            }

            startDataRefresh() {
                setInterval(() => {
                    // Only refresh calendar data - FJ widget handles its own refresh
                    this.loadCalendarData();
                }, this.refreshInterval * 1000);
            }

            setCurrentFeedDuration() {
                // Set duration based on what feed we're currently showing
                if (this.currentFeed === 'calendar' && this.calendarEvents && this.calendarEvents.length > 0) {
                    // We're on calendar - calculate dynamic time
                    this.countdownTimer = this.calculateDynamicRotationTime();
                    console.log(`üìÖ Calendar duration set: ${this.countdownTimer}s for ${this.calendarEvents.length} events`);
                } else {
                    // We're on news - use standard time
                    this.countdownTimer = this.rotationInterval;
                    console.log(`üì∞ News duration set: ${this.countdownTimer}s`);
                }
            }

            showCalendarError(message) {
                const calendarContent = document.getElementById('calendarContent');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = message;
                calendarContent.innerHTML = '';
                calendarContent.appendChild(errorDiv);
            }
        }

        // Initialize widget when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new RotatingWidgetNative();
        });
    </script>
</body>
</html>