<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: '{{ font }}', 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: transparent;
            color: {{ font_color }};
            overflow: hidden;
            /* EVMUX-specific blur fixes */
            -webkit-font-smoothing: subpixel-antialiased;
            -moz-osx-font-smoothing: auto;
            text-rendering: geometricPrecision;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            zoom: 1;
            transform: translateZ(0) scale(1);
        }

        .widget-container {
            width: {{ width }}{% if width.isdigit() %}px{% endif %};
            height: {{ height }}{% if height.isdigit() %}px{% endif %};
            background: transparent;
            border-radius: {{ border_radius }}px;
            padding: {{ padding }}px;
            overflow: hidden;
            position: relative;
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: {{ item_spacing }}px;
            padding-bottom: 8px;
            border-bottom: 1px solid {{ accent_color }}40;
        }

        .widget-title {
            font-size: {{ title_font_size }}px;
            font-weight: 400;
            color: {{ title_color }};
        }

        .rotation-indicator {
            font-size: {{ meta_font_size }}px;
            color: {{ secondary_color }};
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .rotation-dots {
            display: flex;
            gap: 4px;
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: {{ secondary_color }};
            opacity: 0.4;
            transition: opacity 0.3s ease;
        }

        .dot.active {
            opacity: 1;
            background: {{ accent_color }};
        }

        .feed-container {
            height: calc(100% - 50px);
            position: relative;
            overflow: hidden;
        }

        .page-section {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            visibility: hidden;
        }
        
        /* Page 0 (FJ widget) - no transitions to prevent blur */
        #page-0 {
            transition: none !important;
        }
        
        /* Calendar pages - smooth transitions */
        .calendar-page {
            transition: opacity 0.6s ease-in-out, visibility 0.6s ease-in-out;
            transition-behavior: allow-discrete;
        }
        
        /* Warning page */
        .warning-page {
            transition: opacity 0.6s ease-in-out, visibility 0.6s ease-in-out;
            background: {{ item_bg_color }};
            border-radius: {{ border_radius }}px;
            padding: {{ item_padding|int + 10 }}px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            border: 2px solid {{ accent_color }}60;
        }
        
        .warning-title {
            font-size: {{ news_title_size|int + 6 }}px;
            font-weight: 700;
            color: {{ accent_color }};
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .warning-message {
            font-size: {{ font_size|int + 2 }}px;
            color: #ffffff;
            line-height: 1.6;
            max-width: 90%;
            font-weight: 400;
        }

        .page-section.active {
            opacity: 1 !important;
            visibility: visible !important;
        }

        .page-section.exit {
            opacity: 0 !important;
            visibility: hidden !important;
        }

        /* Financial Juice Native Widget Container */
        .fj-native-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            transform: translateZ(0);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .fj-widget-wrapper {
            width: 100%;
            height: 100%;
            position: relative;
            background: {{ item_bg_color }};
            border-radius: {{ border_radius }}px;
            overflow: hidden;
            transform: translateZ(0);
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
        }

        /* Override Financial Juice widget styles - EVMUX optimized */
        .fj-widget-wrapper iframe,
        .fj-widget-wrapper > div {
            width: 100% !important;
            height: 100% !important;
            border: none !important;
            border-radius: {{ border_radius }}px !important;
            /* EVMUX-specific anti-blur properties */
            transform: none !important;
            transition: none !important;
            animation: none !important;
            filter: none !important;
            -webkit-font-smoothing: subpixel-antialiased !important;
            -moz-osx-font-smoothing: auto !important;
            font-smoothing: never !important;
            text-rendering: geometricPrecision !important;
            image-rendering: pixelated !important;
            image-rendering: -moz-crisp-edges !important;
            image-rendering: crisp-edges !important;
            zoom: 1 !important;
            -webkit-transform: translateZ(0) scale(1) !important;
            -webkit-backface-visibility: visible !important;
            backface-visibility: visible !important;
        }

        /* Fallback content for when FJ widget is loading */
        .fj-fallback {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: {{ secondary_color }};
            font-size: {{ font_size }}px;
            background: {{ item_bg_color }};
            border-radius: {{ border_radius }}px;
            border: 1px solid {{ accent_color }}40;
            transform: translateZ(0);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Calendar section styles */
        .pinned-item {
            background: {{ high_impact_bg }};
            border: 1px solid {{ high_impact_color }}40;
            border-radius: {{ border_radius }}px;
            padding: {{ item_padding }}px;
            margin-bottom: {{ item_spacing }}px;
            position: relative;
            overflow: hidden;
        }

        .pinned-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: {{ high_impact_color }};
        }

        .pinned-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: {{ high_impact_color }};
            color: white;
            font-size: {{ badge_font_size }}px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            text-transform: uppercase;
        }

        .pinned-title {
            font-size: {{ news_title_size|int + 2 }}px;
            font-weight: 500;
            color: #ffffff;
            margin-bottom: 4px;
            margin-right: 60px;
            line-height: 1.4;
        }

        .pinned-meta {
            font-size: {{ meta_font_size }}px;
            color: {{ meta_color }};
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feed-content {
            height: calc(100% - 50px);
            overflow: hidden;
            padding-bottom: 5px;
            position: relative;
        }

        .event-item {
            background: {{ item_bg_color }};
            border-radius: {{ border_radius }}px;
            padding: {{ item_padding|int - 2 }}px;
            margin-bottom: {{ item_spacing|int - 2 }}px;
            border: 1px solid {{ accent_color }}40;
            transition: opacity 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
            cursor: pointer;
            position: relative;
            opacity: 1;
        }

        .event-item:hover {
            background: {{ hover_color }};
            border-color: {{ accent_color }}60;
        }

        .item-title {
            font-size: {{ news_title_size|int + 2 }}px;
            font-weight: 500;
            color: {{ news_title_color }};
            margin-bottom: 6px;
            line-height: 1.4;
        }

        .event-item.high-impact .item-title,
        .pinned-item .item-title {
            font-size: {{ news_title_size|int + 4 }}px;
            font-weight: 600;
            color: #ffffff;
            line-height: 1.5;
        }

        .item-meta {
            font-size: {{ meta_font_size }}px;
            color: {{ meta_color }};
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .impact-badge {
            font-size: {{ badge_font_size }}px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 8px;
            text-transform: uppercase;
        }

        .impact-high {
            background: {{ high_impact_color }};
            color: white;
        }

        .impact-medium {
            background: #f59e0b;
            color: white;
        }

        .impact-low {
            background: {{ secondary_color }};
            color: white;
        }

        .event-details {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .currency-flag {
            font-size: {{ badge_font_size|int + 4 }}px;
            background: {{ accent_color }};
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 700;
            min-width: 50px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .event-time {
            color: {{ normal_color }};
            font-weight: 500;
            font-size: {{ meta_font_size|int + 1 }}px;
        }

        .forecast-data {
            font-size: {{ small_font_size|int + 2 }}px;
            color: #ffffff;
            margin-top: 6px;
            line-height: 1.4;
            font-weight: 500;
            background: rgba(0,0,0,0.3);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .status-badge {
            background: #22c55e;
            color: white;
            font-size: {{ badge_font_size }}px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 400;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: {{ secondary_color }};
        }

        .error {
            background: {{ error_color }}20;
            border: 1px solid {{ error_color }};
            color: {{ error_color }};
            padding: 12px;
            border-radius: {{ border_radius }}px;
            text-align: center;
            margin: 20px 0;
        }

        .no-events-message {
            background: {{ item_bg_color }};
            border: 1px solid {{ accent_color }}60;
            border-radius: {{ border_radius }}px;
            padding: {{ item_padding }}px;
            margin: {{ item_spacing }}px 0;
            text-align: center;
            color: #ffffff;
        }

        .no-events-title {
            font-size: {{ news_title_size|int + 1 }}px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .no-events-subtitle {
            font-size: {{ small_font_size|int + 1 }}px;
            color: #e2e8f0;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .no-events-disclaimer {
            font-size: {{ meta_font_size|int + 1 }}px;
            color: #cbd5e0;
            font-style: italic;
            line-height: 1.3;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: slideIn 0.4s ease-out;
        }

        .countdown-timer {
            font-size: {{ meta_font_size }}px;
            color: {{ normal_color }};
            font-weight: 500;
        }

        .feed-type-indicator {
            font-size: {{ meta_font_size }}px;
            color: {{ secondary_color }};
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <div class="widget-container">
        <div class="widget-header">
            <div class="widget-title">{{ title }}</div>
            <div class="rotation-indicator">
                <span class="feed-type-indicator" id="pageType">Financial News</span>
                <div class="rotation-dots" id="pageIndicators">
                    <!-- Dots will be dynamically created based on total pages -->
                </div>
                <span class="countdown-timer" id="countdown">{{ rotation_interval }}s</span>
            </div>
        </div>

        <div class="feed-container">
            <!-- Page 1: Financial Juice News Widget -->
            <div class="page-section active" id="page-0">
                <div class="fj-native-container">
                    <div class="fj-widget-wrapper">
                        <div id="fj-news-widget" class="fj-fallback">
                            Loading Financial Juice news feed...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dynamic calendar pages will be created here -->
            <div id="calendar-pages-container"></div>
            
            <!-- Final warning page will be created here -->
            <div id="warning-page-container"></div>
        </div>
    </div>

    <!-- Financial Juice Widget Script -->
    <script>
        function loadFinancialJuiceWidget() {
            const container = document.getElementById('fj-news-widget');
            
            // Replace the container with the FJ widget container
            container.id = 'financialjuice-news-widget-container';
            container.className = '';
            container.innerHTML = '';
            
            // Create and load the Financial Juice widget script
            var jo = document.createElement("script");
            jo.type = "text/javascript";
            jo.id = "FJ-Widgets";
            var r = Math.floor(Math.random() * (9999 - 0 + 1) + 0);
            jo.src = "https://feed.financialjuice.com/widgets/widgets.js?r=" + r + "";
            jo.onload = function() { 
                var options = {};
                options.container = "financialjuice-news-widget-container";
                options.mode = "Dark";
                options.width = "268px";
                options.height = "410px";
                options.backColor = "{{ bg_color|replace('#', '') }}";
                options.fontColor = "{{ font_color|replace('#', '') }}";
                options.widgetType = "NEWS";
                new window.FJWidgets.createWidget(options);
            };
            document.getElementsByTagName("head")[0].appendChild(jo);
        }
    </script>

    <script>
        class RotatingWidgetNative {
            constructor() {
                this.currentPage = 0;
                this.totalPages = 1; // Start with just FJ page
                this.pageInterval = {{ rotation_interval }}; // Time per page
                this.refreshInterval = {{ refresh_interval }};
                this.countdownTimer = this.pageInterval;
                this.isRotating = {{ auto_rotate }};
                this.calendarEvents = [];
                this.eventsPerPage = 4;
                
                this.initializeWidget();
                this.startDataRefresh();
                // Start rotation after calendar data loads
                setTimeout(() => {
                    this.startRotation();
                }, 2000);
            }

            initializeWidget() {
                // Load Financial Juice native widget
                loadFinancialJuiceWidget();
                
                // Load calendar data
                this.loadCalendarData();
                
                // Create initial page indicators (will update when calendar loads)
                this.updatePageIndicators();
            }

            async loadCalendarData() {
                try {
                    const response = await fetch('/api/combined/rotation-data?news_count={{ news_count }}&events_count={{ events_count }}');
                    const result = await response.json();
                    
                    if (result.success && result.data.calendar_feed.items) {
                        this.calendarEvents = result.data.calendar_feed.items;
                        console.log(`📊 Loaded ${this.calendarEvents.length} calendar events`);
                        this.buildAllPages();
                    } else {
                        console.log('⚠️ No calendar events available');
                        this.buildAllPages(); // Build with just FJ + warning pages
                    }
                } catch (error) {
                    console.error('Error loading calendar data:', error);
                    this.buildAllPages(); // Build minimal pages on error
                }
            }

            buildAllPages() {
                // Calculate total pages: FJ + Calendar pages + Warning
                const calendarPages = Math.ceil(this.calendarEvents.length / this.eventsPerPage);
                this.totalPages = 1 + calendarPages + 1; // FJ + Calendar + Warning
                
                console.log(`📑 Building ${this.totalPages} pages: 1 FJ + ${calendarPages} calendar + 1 warning`);
                
                // Build calendar pages
                this.createCalendarPages();
                
                // Build warning page
                this.createWarningPage();
                
                // Update page indicators
                this.updatePageIndicators();
            }

            createCalendarPages() {
                const container = document.getElementById('calendar-pages-container');
                container.innerHTML = '';
                
                if (this.calendarEvents.length === 0) return;
                
                const calendarPages = Math.ceil(this.calendarEvents.length / this.eventsPerPage);
                
                for (let pageNum = 0; pageNum < calendarPages; pageNum++) {
                    const pageDiv = document.createElement('div');
                    pageDiv.className = 'page-section calendar-page';
                    pageDiv.id = `page-${pageNum + 1}`; // Pages 1, 2, 3... (FJ is page 0)
                    
                    const startIndex = pageNum * this.eventsPerPage;
                    const endIndex = Math.min(startIndex + this.eventsPerPage, this.calendarEvents.length);
                    const pageEvents = this.calendarEvents.slice(startIndex, endIndex);
                    
                    pageEvents.forEach(event => {
                        const eventElement = this.createEventItem(event);
                        pageDiv.appendChild(eventElement);
                    });
                    
                    container.appendChild(pageDiv);
                }
                
                console.log(`📅 Created ${calendarPages} calendar pages`);
            }
            
            createWarningPage() {
                const container = document.getElementById('warning-page-container');
                container.innerHTML = '';
                
                const pageDiv = document.createElement('div');
                pageDiv.className = 'page-section warning-page';
                pageDiv.id = `page-${this.totalPages - 1}`; // Last page
                
                pageDiv.innerHTML = `
                    <div class="warning-title">⚠️ Market Alert</div>
                    <div class="warning-message">
                        Other economic events may trigger market volatility. 
                        Always check multiple sources for additional news that could impact trading.
                    </div>
                `;
                
                container.appendChild(pageDiv);
                console.log('⚠️ Created warning page');
            }
            
            updatePageIndicators() {
                const container = document.getElementById('pageIndicators');
                container.innerHTML = '';
                
                for (let i = 0; i < this.totalPages; i++) {
                    const dot = document.createElement('div');
                    dot.className = `dot ${i === 0 ? 'active' : ''}`;
                    dot.dataset.page = i;
                    container.appendChild(dot);
                }
            }

            createEventItem(item) {
                const div = document.createElement('div');
                div.className = 'event-item';
                
                // Enhanced forecast data with better visibility
                let forecastHtml = '';
                if (item.actual || item.forecast || item.previous) {
                    const parts = [];
                    if (item.actual) parts.push(`<strong>Actual: ${item.actual}</strong>`);
                    if (item.forecast) parts.push(`Forecast: ${item.forecast}`);
                    if (item.previous) parts.push(`Previous: ${item.previous}`);
                    
                    forecastHtml = `<div class="forecast-data">${parts.join(' | ')}</div>`;
                }
                
                div.innerHTML = `
                    <div class="item-title">${item.title}</div>
                    <div class="event-details">
                        <span class="currency-flag">${item.country}</span>
                        <span class="event-time">${item.time_until}</span>
                        <span class="impact-badge impact-${item.impact.toLowerCase()}">${item.impact}</span>
                        ${item.status === 'completed' ? '<span class="status-badge">✓</span>' : ''}
                    </div>
                    ${forecastHtml}
                `;
                
                // Add animation on creation
                div.style.opacity = '0.4';
                div.style.transition = 'opacity 0.5s ease';
                setTimeout(() => {
                    div.style.opacity = '1';
                }, 100);
                
                return div;
            }

            startRotation() {
                if (!this.isRotating) return;
                
                console.log(`🔄 Starting rotation: ${this.totalPages} pages, ${this.pageInterval}s each`);
                
                this.rotationTimer = setInterval(() => {
                    this.countdownTimer--;
                    document.getElementById('countdown').textContent = this.countdownTimer + 's';
                    
                    if (this.countdownTimer <= 0) {
                        this.currentPage = (this.currentPage + 1) % this.totalPages;
                        this.switchToPage(this.currentPage);
                        this.countdownTimer = this.pageInterval;
                    }
                }, 1000);
            }
            
            switchToPage(pageNumber) {
                console.log(`📄 Switching to page ${pageNumber}: ${this.getPageName(pageNumber)}`);
                
                // Hide all pages
                document.querySelectorAll('.page-section').forEach(page => {
                    page.classList.remove('active');
                });
                
                // Show target page
                const targetPage = document.getElementById(`page-${pageNumber}`);
                if (targetPage) {
                    targetPage.classList.add('active');
                } else {
                    console.error(`❌ Page ${pageNumber} not found!`);
                }
                
                // Update indicators
                document.querySelectorAll('.dot').forEach((dot, index) => {
                    dot.classList.toggle('active', index === pageNumber);
                });
                
                // Update page type display
                document.getElementById('pageType').textContent = this.getPageName(pageNumber);
            }
            
            getPageName(pageNumber) {
                if (pageNumber === 0) return 'Financial News';
                if (pageNumber === this.totalPages - 1) return 'Market Alert';
                return `Economic Events ${pageNumber}`;
            }

            startDataRefresh() {
                setInterval(() => {
                    console.log('🔄 Refreshing calendar data...');
                    this.loadCalendarData();
                }, this.refreshInterval * 1000);
            }
            

            startDataRefresh() {
                setInterval(() => {
                    // Only refresh calendar data - FJ widget handles its own refresh
                    this.loadCalendarData();
                }, this.refreshInterval * 1000);
            }


        }

        // Initialize widget when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new RotatingWidgetNative();
        });
    </script>
</body>
</html>